#include "mbed.h"

#define SDA PB_9
#define SCL PB_8
#define ADDR 0x02

AnalogIn ain(PA_0);
I2CSlave slave(SDA, SCL);
Serial pc(SERIAL_TX, SERIAL_RX);

char msg[2];

int main()
{
    msg[0]=0;
    msg[1]=0;
    
    slave.frequency(100000);
    int receive;
    slave.address(ADDR);
    while(1) {
        receive = slave.receive();
        if(receive==1) {
            float fval = ain.read();
            int ival = (int) (fval*5000.0);
            char hbyte = ival / 256; 
            char lbyte = ival % 256;
            msg[0] = hbyte;
            msg[1] = lbyte;           
            slave.write(msg,2);
            pc.printf("fval: %.4f, ADC: %d, hbyte: %d, lbyte: %d\n",fval,ival,lbyte,hbyte);
        }
    }
}
